<!DOCTYPE html>
<html>
<head>
    {{include "admin/header.html" .}}
</head>
<body class="hold-transition login-page">
<div class="login-box">
    <div class="login-logo">
        <a href="/"><b>GoFrame</b>管理平台</a>
    </div>
    <!-- /.login-logo -->
    <div class="card">
        <div class="card-body login-card-body">
            <p class="login-box-msg">请输入登录信息</p>

            <form id="loginForm" action="/admin/login/do" method="post">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" minlength="3" maxlength="20" name="passport"
                           placeholder="请输入帐号" required>
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-envelope"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input type="password" class="form-control" minlength="6" maxlength="20" name="password"
                           placeholder="请输入密码" required>
                    <div class="input-group-append">
                        <div class="input-group-text">
                            <span class="fas fa-lock"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input type="text" name="captcha" class="form-control" minlength="4" maxlength="4"
                           placeholder="请输入验证码" required>
                    <div class="input-group-append">
                        <span class="input-group-text" style="cursor: pointer;padding: 0;">
                            <img style="line-height: 36px;height: 36px;" id="code-img" class="captcha" loading="lazy"
                                 onclick="gf.reloadCaptcha()">
                        </span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8">
                        <div class="icheck-primary">
                            <input type="checkbox" id="remember">
                            <label for="remember">
                                记住密码
                            </label>
                        </div>
                    </div>
                    <!-- /.col -->
                    <div class="col-4">
                        <button type="submit" class="btn btn-primary btn-block">登录</button>
                    </div>
                    <!-- /.col -->
                </div>
            </form>

            <div class="social-auth-links text-center mb-3">
                <p>----</p>
                <a href="/" target="_blank" class="btn btn-block btn-success">
                    <span class="iconfont" style="font-size: 18px;">&#xe6eb;</span> 访问首页
                </a>
            </div>
            <!-- /.social-auth-links -->

            <p class="mb-1">
                <a href="javascript:void(0);" onclick="swal({text: '请联系管理员'});">忘记密码</a>
            </p>
        </div>
        <!-- /.login-card-body -->
    </div>
</div>
<!-- /.login-box -->

</body>
</html>
<script type="text/javascript">

    jQuery(function ($) {
        var storagePassport = window.localStorage.getItem("passport") || "";
        var storagePassword = window.localStorage.getItem("password") || "";
        if (storagePassport != "") {
            $('[name="passport"]').val(storagePassport);
        }
        if (storagePassword != "") {
            $('[name="password"]').val(storagePassword);
            $("#remember").prop("checked", true);
        }

        gf.reloadCaptcha()

        // footer悬浮
        $("footer").addClass("fixed-bottom");

        $('#loginForm').validate({
            errorElement: 'div',
            errorClass: 'validation-error-block',
            focusInvalid: true,
            messages: {
                passport: {
                    required: "请输入账号"
                },
                password: {
                    required: "请输入密码"
                },
                captcha: {
                    required: "请确认验证码"
                }
            },
            submitHandler: function (form) {
                $('button[type=submit]').attr('disabled', 'true');

                let passport = $('[name="passport"]').val();
                let password = $('[name="password"]').val();
                $('[name="password"]').val(hex_md5(passport + password));
                jQuery(form).ajaxSubmit({
                    dataType: 'json',
                    success: function (r, textStatus) {
                        if (r.code == 0) {
                            swal({
                                title: "登录成功",
                                text: "页面将自动跳转到登录前页面",
                                icon: "success",
                                timer: 2000,
                                buttons: false
                            }).then((value) => {
                                // 记住上一次成功帐号
                                window.localStorage.setItem("passport", passport);
                                // 记住密码
                                if ($("#remember").is(":checked")) {
                                    window.localStorage.setItem("password", password);
                                } else {
                                    window.localStorage.removeItem("password");
                                }

                                if (r.redirect != "") {
                                    window.location.href = r.redirect;
                                } else {
                                    window.location.href = "/admin";
                                }
                            });
                        } else {
                            swal({
                                text: r.message,
                                icon: "warning",
                                button: "确定",
                            });
                            $('[name="password"]').val('');
                            gf.reloadCaptcha()
                        }
                    }
                });
                $('button[type=submit]').removeAttr('disabled');
            },
            errorPlacement: function (error, element) {
                element.addClass("is-invalid")
                error.appendTo(element.parent());
            }
        });
    });
</script>